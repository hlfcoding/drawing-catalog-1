<!DOCTYPE html><html lang="en"><head><title>sketches/Elementary/Elementary</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="sketches/Elementary/Elementary"><meta name="groc-project-path" content="sketches/Elementary/Elementary.pde"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">sketches/Elementary/Elementary.pde</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="elementary">Elementary</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>In addition to the sketch, this file houses various other support code and
helpers.</p></div></div><div class="code"><div class="wrapper">sketch = <span class="hljs-literal">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="initializers">Initializers</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Initialize:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">setup</span>: <span class="hljs-function">-&gt;</span>   

  <span class="hljs-comment">#- Required for CS-P5-mode parser.</span>
  <span class="hljs-comment">#- size(720, 480);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>sketch</code> global is actually a reference to the sketch instance. This
approach is unique to the CS-P5 mode implementation. It acts as a namespace
for other globals, to make globals more apparent.</p></div></div><div class="code"><div class="wrapper">  sketch = @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The sketch instance also keeps a <code>state</code> namespace with attributes related
to sketch state. Aside from the sketch, it should be read-only.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@state</span> =
    <span class="hljs-attribute">frozen</span>: <span class="hljs-literal">no</span>
    <span class="hljs-attribute">speedFactor</span>: <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First, initialize constants and extensions. These make the Processing API
even better.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_setupConstants</span>()
  <span class="hljs-property">@_setupExtensions</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Next, update any globals required for initializing classes. Class defaults
may require additional globals.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@state</span>.frameRate = frameRate.FILM
  <span class="hljs-property">@_updateSpeedFactor</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Next, initialize classes, including setting any less-static defaults.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_setupClasses</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Next, initialize Processing sketch settings.</p></div></div><div class="code"><div class="wrapper">  colorMode RGB, <span class="hljs-number">255</span>
  noStroke()
  [w, h] = size.MEDIUM <span class="hljs-comment"># Update size here.</span>
  size w, h
  background color.WHITE
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Next, initialize, along with its <code>Node</code>s, a single instance of <code>Wrap</code> called
<code>stage</code>, and keep it on <code>sketch</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_setupStage</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Next, initialize the stores for canvas image data, ie. to store screens so
view modes can be toggled non-destructively, and so image data can be
exported.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_setupScreens</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Last, initialize the controls for any mutable, configurable values in the
sketch, making the sketch much more interactive and powerful.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_setupGUI</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ยง</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for constants:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupConstants</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Constants, when possible, are attached to the Processing (sketch) API methods.
This is because scope globals are of limited use in CS mode, and globalized
methods are conveniently fitting as namespaces, despite being a little risky
to modify.</p></div></div><div class="code"><div class="wrapper">  color.BLACK = color <span class="hljs-number">0</span>
  color.WHITE = color <span class="hljs-number">255</span>
  color.RED = color <span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>

  frameRate.DEBUG = <span class="hljs-number">1</span>
  frameRate.ANIMATION = <span class="hljs-number">12</span>
  frameRate.FILM = <span class="hljs-number">24</span>
  frameRate.VIDEO = <span class="hljs-number">30</span>
  frameRate.REAL = <span class="hljs-number">60</span>

  size.SMALL = [<span class="hljs-number">300</span>, <span class="hljs-number">300</span>]
  size.MEDIUM = [<span class="hljs-number">720</span>, <span class="hljs-number">480</span>]
  size.TWITTER = [<span class="hljs-number">1252</span>, <span class="hljs-number">626</span>]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for extensions:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupExtensions</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>PVector extension to add helper constants and methods for the sketch. The main
addition is the concept of a vector type.</li>
</ul></div></div><div class="code"><div class="wrapper">  PVector.G = <span class="hljs-number">0.01</span>

  PVector.GENERIC = <span class="hljs-number">0</span>
  PVector.POSITION = <span class="hljs-number">1</span>
  PVector.VELOCITY = <span class="hljs-number">2</span>
  PVector.ACCELERATION = <span class="hljs-number">3</span>

  PVector.GRAVITY = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>
  PVector.ATTRACTION = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>

  PVector.createGravity = <span class="hljs-function">=&gt;</span>
    vec = <span class="hljs-keyword">new</span> PVector <span class="hljs-number">0</span>, <span class="hljs-property">@state</span>.speedFactor / <span class="hljs-number">2</span>
    vec.type = PVector.GRAVITY
    vec

  <span class="hljs-attribute">PVector</span>::randomize = <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> PVector.POSITION
    <span class="hljs-property">@x</span> = random width
    <span class="hljs-property">@y</span> = random height</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add helpers to the color API methods, mainly for conversion.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">#-This should be less magical.</span>
  color.ensure = <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span> <span class="hljs-keyword">if</span> c &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> c - <span class="hljs-number">16777216</span> <span class="hljs-keyword">else</span> c

  color.transparentize = <span class="hljs-function"><span class="hljs-params">(c, ratio)</span> -&gt;</span> color red(c), green(c), blue(c), alpha(c) * ratio</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add helpers to number methods, mainly for macro-calculations.</li>
</ul></div></div><div class="code"><div class="wrapper">  random.dualScale = <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> random(<span class="hljs-number">1</span>, n) / random(<span class="hljs-number">1</span>, n)
  random.item = <span class="hljs-function"><span class="hljs-params">(list)</span> -&gt;</span> list[_.random(list.length - <span class="hljs-number">1</span>)]
  random.signed = <span class="hljs-function">-&gt;</span> random -<span class="hljs-number">1</span>, <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add core helpers.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">#-Currently unused.</span>
  Processing.isKindOfClass = <span class="hljs-function"><span class="hljs-params">(obj, aClass)</span> -&gt;</span>
    test = obj.constructor <span class="hljs-keyword">is</span> aClass
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bool <span class="hljs-keyword">and</span> obj.constructor.__super__?
      test = isKindOfClass obj.constructor.__super__, aClass
    test</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for classes:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupClasses</span>: <span class="hljs-function">-&gt;</span>

  Node.setup()
  Wrap.setup()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for controls:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupGUI</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The sketch has state and the dat.GUI library builds an interface to manipulate
and tune that state for various results.</p></div></div><div class="code"><div class="wrapper">  gui = <span class="hljs-keyword">new</span> dat.GUI()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add sketch controls.</li>
</ul></div></div><div class="code"><div class="wrapper">  folder = gui.addFolder <span class="hljs-string">'sketch'</span>

  toggle = folder.add <span class="hljs-property">@state</span>, <span class="hljs-string">'frozen'</span>
  toggle.onFinishChange (toggled) =&gt; <span class="hljs-property">@freeze</span> toggled

  select = folder.add <span class="hljs-property">@state</span>, <span class="hljs-string">'frameRate'</span>,
    <span class="hljs-string">'Debug'</span>: frameRate.DEBUG
    <span class="hljs-string">'Animation'</span>: frameRate.ANIMATION
    <span class="hljs-string">'Film'</span>: frameRate.FILM
    <span class="hljs-string">'Video'</span>: frameRate.VIDEO
    <span class="hljs-string">'Real'</span>: frameRate.REAL
  select.onFinishChange (option) =&gt; <span class="hljs-property">@state</span>.frameRate = parseInt option, <span class="hljs-number">10</span>

  button = folder.add @, <span class="hljs-string">'exportScreen'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add stage controls.</li>
</ul></div></div><div class="code"><div class="wrapper">  folder = gui.addFolder <span class="hljs-string">'stage'</span>

  colorPicker = folder.addColor <span class="hljs-property">@stage</span>, <span class="hljs-string">'fill'</span>
  <span class="hljs-comment">#-<span class="hljs-doctag">NOTE:</span> onFinishChange somehow doesn't work.</span>
  colorPicker.onChange (color) =&gt; <span class="hljs-property">@stage</span>.fillColor color

  range = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'entropy'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>

  range = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'frictionMag'</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.1</span>

  range = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'nodeCount'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">500</span>
  range.onFinishChange (count) =&gt; <span class="hljs-property">@stage</span>.updateNodeCount count
  range.listen()

  toggle = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'gravity'</span>
  toggle.onFinishChange (toggled) =&gt;
    <span class="hljs-property">@stage</span>.containment = <span class="hljs-keyword">if</span> toggled <span class="hljs-keyword">then</span> Wrap.REFLECTIVE <span class="hljs-keyword">else</span> Wrap.TOROIDAL
    <span class="hljs-property">@stage</span>.toggleForce PVector.GRAVITY, toggled

  select = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'containment'</span>,
    <span class="hljs-string">'Reflective'</span>: Wrap.REFLECTIVE
    <span class="hljs-string">'Toroidal'</span>: Wrap.TOROIDAL
  select.onFinishChange (option) =&gt; <span class="hljs-property">@stage</span>.containment = parseInt option, <span class="hljs-number">10</span>

  button = folder.add <span class="hljs-property">@stage</span>, <span class="hljs-string">'clear'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Add node controls.</li>
</ul></div></div><div class="code"><div class="wrapper">  folder = gui.addFolder <span class="hljs-string">'node'</span>
<span class="hljs-function">
  <span class="hljs-title">createNodeParamsUpdater</span> = <span class="hljs-params">(attribute, accessor)</span> =&gt;</span>
    (value) =&gt;
      <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-property">@stage</span>.nodes
        <span class="hljs-keyword">if</span> accessor? <span class="hljs-keyword">then</span> n[accessor] value
        <span class="hljs-keyword">else</span> n[attribute] = value

  colorPicker = folder.addColor <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'stroke'</span>
  colorPicker.onChange createNodeParamsUpdater(<span class="hljs-string">'stroke'</span>, <span class="hljs-string">'strokeColor'</span>)

  range = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'vMax'</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@stage</span>.nodeParams.vMax * <span class="hljs-number">2</span>
  range.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'vMax'</span>)

  range = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'attractDecayRate'</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@stage</span>.nodeParams.attractDecayRate * <span class="hljs-number">2</span>
  range.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'attractDecayRate'</span>)

  range = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'evadeLifespan'</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@stage</span>.nodeParams.evadeLifespan * <span class="hljs-number">2</span>
  range.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'evadeLifespan'</span>)

  range = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'tempRepulsionDecayRate'</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@stage</span>.nodeParams.tempRepulsionDecayRate * <span class="hljs-number">2</span>
  range.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'tempRepulsionDecayRate'</span>)

  toggle = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'attract'</span>
  toggle.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'attract'</span>, <span class="hljs-string">'isAttractor'</span>)

  toggle = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'collide'</span>
  toggle.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'collide'</span>)

  toggle = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'varyMass'</span>
  toggle.onFinishChange createNodeParamsUpdater(<span class="hljs-string">'varyMass'</span>)

  select = folder.add <span class="hljs-property">@stage</span>.nodeParams, <span class="hljs-string">'viewMode'</span>,
    <span class="hljs-string">'Ball'</span>: Node.BALL
    <span class="hljs-string">'Line'</span>: Node.LINE
  select.onFinishChange (option) =&gt; <span class="hljs-property">@stage</span>.onNodeViewModeChange parseInt option, <span class="hljs-number">10</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Export as a global onto the library itself.</p></div></div><div class="code"><div class="wrapper">  dat.GUI.shared = gui

  gui.open()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for image data storage:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupScreens</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Screens can store and restore canvas state when switching between different
draw modes.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_screenStacks</span> = {}
  <span class="hljs-property">@_screenStacks</span>[Wrap.TRACE] = []
  <span class="hljs-property">@_screenStacks</span>[Wrap.DEFAULT] = []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An initializer for the stage and its nodes:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">_setupStage</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The sketch only has one Wrap, and filling the sketch, it acts like a &#39;stage&#39;.</p></div></div><div class="code"><div class="wrapper">  wind = <span class="hljs-keyword">new</span> PVector <span class="hljs-number">0.001</span>, <span class="hljs-number">0</span>
  <span class="hljs-property">@stage</span> = <span class="hljs-keyword">new</span> Wrap
    <span class="hljs-attribute">id</span>: <span class="hljs-number">1</span>
    <span class="hljs-attribute">containment</span>: Wrap.TOROIDAL
    <span class="hljs-attribute">customForces</span>: [ wind ]
    <span class="hljs-attribute">h</span>: height
    <span class="hljs-attribute">w</span>: width

  <span class="hljs-property">@stage</span>.updateNodeCount()

  <span class="hljs-property">@stage</span>.ready <span class="hljs-literal">yes</span>
  <span class="hljs-property">@canvasElement</span>().focus()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="updaters">Updaters</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update loop:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">draw</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@stage</span>.draw()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Stop updating:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">freeze</span>: <span class="hljs-function"><span class="hljs-params">(frozen)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>One of the first things we need to do is to be able to control the cycle-
expensive run state without stopping the server. This is especially handy when
LiveReload is used.</p></div></div><div class="code"><div class="wrapper">  frozen ?= <span class="hljs-property">@state</span>.frozen

  n.move = !frozen <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-property">@stage</span>.nodes
  <span class="hljs-keyword">if</span> frozen <span class="hljs-keyword">then</span> noLoop()
  <span class="hljs-keyword">else</span> <span class="hljs-property">@loop</span>()

  <span class="hljs-property">@state</span>.frozen = frozen

<span class="hljs-attribute">_updateSpeedFactor</span>: <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@state</span>.speedFactor = frameRate.REAL / <span class="hljs-property">@state</span>.frameRate
  frameRate <span class="hljs-property">@state</span>.frameRate</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="canvas-state">Canvas State</h2>
<p>Some DOM-related logic:</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">canvasElement</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@contentElement</span>().querySelector <span class="hljs-string">'canvas'</span>
<span class="hljs-attribute">contentElement</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-built_in">document</span>.getElementById <span class="hljs-string">'content'</span>

<span class="hljs-attribute">exportScreen</span>: <span class="hljs-function">-&gt;</span>
  img = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'img'</span>
  img.src = <span class="hljs-property">@canvasElement</span>().toDataURL()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@_imgPrev</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@contentElement</span>().insertBefore img, <span class="hljs-property">@_imgPrev</span>
  <span class="hljs-keyword">else</span> <span class="hljs-property">@contentElement</span>().appendChild img
  <span class="hljs-property">@_imgPrev</span> = img

<span class="hljs-attribute">pushScreen</span>: <span class="hljs-function"><span class="hljs-params">(customStack)</span> -&gt;</span>
  [context, stack] = <span class="hljs-property">@_screenUpdateVars</span>()
  stack = customStack <span class="hljs-keyword">if</span> customStack?
  screen = context.getImageData <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height
  <span class="hljs-property">@_screenStacks</span>[stack].push screen

<span class="hljs-attribute">popScreen</span>: <span class="hljs-function">-&gt;</span>
  [context, stack] = <span class="hljs-property">@_screenUpdateVars</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@_screenStacks</span>[stack].length
  context.putImageData <span class="hljs-property">@_screenStacks</span>[stack].pop(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>

<span class="hljs-attribute">_screenUpdateVars</span>: <span class="hljs-function">-&gt;</span>
  context = <span class="hljs-property">@canvasElement</span>().getContext <span class="hljs-string">'2d'</span>
  stack = <span class="hljs-keyword">if</span> <span class="hljs-property">@stage</span>.trace <span class="hljs-keyword">is</span> <span class="hljs-literal">on</span> <span class="hljs-keyword">then</span> Wrap.TRACE <span class="hljs-keyword">else</span> Wrap.DEFAULT
  [context, stack]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="responders">Responders</h2>
<p>Some ad-hoc user input handling. Not as good as DOM events.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">mouseClicked</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@stage</span>.mouseClicked()</div></div></div></div></body></html>